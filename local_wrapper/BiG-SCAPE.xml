<tool id="big-scape" name="BiG-SCAPE" version="1.1.5+galaxy0" profile="21.05">
       <description> construct sequence similarity networks of BGCs and groups them into GCF</description>
       <requirements>
              <requirement type="package" version="0.0.1">foobar</requirement>
       </requirements>
       <command detect_errors="exit_code">
       <![CDATA[

              mkdir input;
              #for $files in $inputdir:
                     ln -s $files input/$files.element_identifier;
              #end for

              mkdir result;

              mkdir output;

              mkdir pfam;
              ln -s $pfam_dir pfam/$pfam_dir.element_identifier;
              hmmpress pfam/Pfam-A.hmm;

              #if $anchor.is_select == "yes":
                     ln -s $anchorfile $anchorfile.element_identifier;
              #end if
              #if $query.is_select == "yes":
                     ln -s $query_bgc $query_bgc.element_identifier;
              #end if
              #if $list.is_select == "yes":
                     cat $domain_includelist > $__tool_directory__/BiG-SCAPE/domain_includelist.txt;
              #end if

              python3 $__tool_directory__/BiG-SCAPE/bigscape.py 
              --inputdir input
              --outputdir result
              #if $use_label.is_select == "yes":
                     --label ${label}
              #end if
              #if $include_gbk.is_select == "yes":
                     --include_gbk_str ${include_gbk_str}
              #end if
              #if $exclude_gbk.is_select == "yes":
                     --exclude_gbk_str ${exclude_gbk_str}
              #end if
              --pfam_dir pfam
              --core \${GALAXY_SLOTS:-8}
              ${verbose}
              ${include_singletons}
              --domain_overlap_cutoff ${domain_overlap_cutoff}
              --min_bgc_size ${min_big_size}
              ${mix}
              ${no_classify}
              #if $banned_classes.value: 
                     --banned_classes
                     #for $banned in str( $banned_classes).split( "," ):  
                            $banned  
                     #end for
              #end if
              --cutoffs $cutoffs
              ${clans_off}
              #if $clans_cutoff.is_select == "yes":
                     --clans_cutoff $clans_cutoff_val1 $clans_cutoff_val2
              #end if
              ${hybrids_off}
              --mode ${mode.value}
              #if $anchor.is_select == "yes":
                     --anchorfile ${anchorfile.element_identifier}
              #end if
              ${force_hmmscan}
              ${skip_ma}
              #if $mibig.is_select == "yes":
                     $mibig.mibig.value
              #end if
              #if $query.is_select == "yes":
                     --query_bgc ${query_bgc.element_identifier}
              #end if
              #if $list.is_select == "yes":
                     --domain_includelist
              #end if
              ;

              mv result/*.html output;
              mv result/network_files output;
              mv result/html_content output;

              zip -r output.zip output;
       ]]>
       </command>
       <inputs>
              <param argument="--inputdir" format=".gbk" multiple="true" type="data"
                     label="Data files to inlcude in the clustering" 
                     help="Add your .gbk files here" />
              <conditional name="use_label" >
                     <param name="is_select" type="select" label="Adding extra string to BiG-SCAPE runs?"
                            help="Select yes if you want to add an extra string to the outputs">
                            <option value="yes" selected="False"> Yes </option>
                            <option value="no" selected="True"> No </option>
                     </param>
                     <when value="yes">
                            <param argument="--label" type="text" value="" optional="false" label="Adding extra string to BiG-SCAPE runs name"
                                   help="By default the BiG-SCAPE runs are named as (YYYY-MM-DD_HH-MM-SS_[extra]) where extra means the mode and if activated (hybrids).">
                                   <validator type="empty_field" />
                            </param>
                     </when>
                     <when value="no" />
              </conditional>
              <conditional name="include_gbk" >
                     <param name="is_select" type="select" label="Include file(s) with certain string(s)?"
                            help="Select yes if you want to include file(s) with certain string(s)">
                            <option value="yes" selected="False"> Yes </option>
                            <option value="no" selected="True"> No </option>
                     </param>
                     <when value="yes">
                            <param argument="--include_gbk_str" type="text" value="" optional="false" label="Include file(s) who contain followed string(s)"
                                   help="Include file(s) with a space seperated list wherer any of the string(s) are contain in the file(s) name. To use all files just type an asterisk (*), this also overwrite the enclude_gbk_str command!">
                                   <validator type="empty_field" />
                            </param>
                     </when>
                     <when value="no" />
              </conditional>
              <conditional name="exclude_gbk" >
                     <param name="is_select" type="select" label="Exclude file(s) with certain string(s)?"
                            help="Select yes if you want to eclude file(s) with certain string(s)">
                            <option value="yes" selected="False"> Yes </option>
                            <option value="no" selected="True"> No </option>
                     </param>
                     <when value="yes">
                            <param argument="--exclude_gbk_str" type="text" value="" optional="false" label="Exclude file(s) who contain followed string(S)"
                                   help="Exclude file(S) with a space seperated list wherer any of the string(s) are contain in the file(s) name">
                                   <validator type="empty_field" />
                            </param>
                     </when>
                     <when value="no" />
              </conditional>
              <param argument="--pfam_dir" format=".hmm" type="data"
                     label="Data file Pfam-A.hmm"
                     help="Add Pfam-A.hmm file here please. Look at the help section where you can download it!" />
              <param argument="--verbose" type="boolean" truevalue="--verbose" falsevalue="" checked="False"
                     label="Print more detailed information about each step"
                     help="Getting more information about the analysis if toggled is true." />
              <param argument="--include_singletons" type="boolean" truevalue="--include_singletons" falsevalue="" checked="False"
                     label="Include BGCs with lower cutoff distance" 
                     help="With this option you can include BGCs who doesnt have a distance lower then the cutoff distance specified" /> 
              <param argument="--domain_overlap_cutoff" type="float" value="0.1" min="0.0" max="1.0"
                     label="Specify when domains are considered to overlap"
                     help="When using this option you can sprecify at which percentage domains are considered to overlap. Domain with the best score is kept. The default value is 0.1" />
              <param argument="--min_big_size" type="integer" value="0" min="0" 
                     label="Minimum size of a BGC (bp)"
                     help="Minimum size of a BGC to be included in the analysis. The Default value is 0 base pairs. This also inlcudes the sum of all loci in a multi-record GenBandk file." />
              <param argument="--mix" type="boolean" truevalue="--mix" falsevalue="" checked="False"
                     label="mix all classes in the analysis"
                     help="BiG-SCAPE seperates the analysis according to the BGC product by default. If used BiG-SCAPE will mix all classes and analyse them." />
              <param argument="--no_classify" type="boolean" truevalue="--no_classify" falsevalue="" checked="False"
                     label="No classified output based on the BGC product"
                     help="By default, BiG-SCAPE classifies the output based on the BGC product. If toggled it will deactivate it. Note: when (--mix) is not activated, BiG-SCAPE will not create any network file!" />
              <param argument="--banned_classes" type="select" optional="true" multiple="true" display="checkboxes"
                     label="Exluded classes from classification in BiG-SCAPE"
                     help="You can exclude any of this classes to not be classifed. Multipe banned classes are possible." >
                     <option value="PKSI" selected="False">PKSI</option>
                     <option value="PKother" selected="False">PKother</option>
                     <option value="NRPS" selected="False">NRPS</option>
                     <option value="RIPPs" selected="False">RIPPs</option>
                     <option value="Saccharides" selected="False">Saccharides</option>
                     <option value="Terpene" selected="False">Terpene</option>
                     <option value="PKS-NRP_Hybrids" selected="False">PKS-NRP_Hybrids</option>
                     <option value="Others" selected="False">Others</option>
              </param>
              <param argument="--cutoffs" type="text" value="0.3" min="0.0" max="1.0" optional="false"
                     label="GCF cutoff value"
                     help="Generate networks using muliple raw distance cutoffs values. The default value here is 0.3."/>
              <param argument="--clans-off" type="boolean" truevalue="--clans-off" falsevalue="" checked="False"
                     label="Turn off cluster GCFs into GCCs"
                     help="By default, BiG-SCAPE will perform a second layer of clustering to group GCFs into GCCs. Toggle to deactivate this." />
              <conditional name="clans_cutoff" >
                     <param name="is_select" type="select" label="Change cutoff values for cluster GCF into GCC?"
                            help="Select yes if you want to change cutoffs for cluster families into clans.">
                            <option value="yes" selected="False"> Yes </option>
                            <option value="no" selected="True"> No </option>
                     </param>
                     <when value="yes">
                            <param name="clans_cutoff_val1" type="float" value="0.3" min="0.0" max="1.0" label="GCF cutoff value"
                                   help="This value is for finding GCFs which will be used for clan calling. The default value is 0.3." />
                            <param name="clans_cutoff_val2" type="float" value="0.7" min="0.0" max="1.0" label="GCC cutoff value"
                                   help="This value is for clustering families into clans. The default value is 0.7. Every pair of GCFs linked with a distance of this value or less will be taken into account!" />
                     </when>
                     <when value="no" />
              </conditional>
              <param argument="--hybrids_off" type="boolean" truevalue="--hybrids-off" falsevalue="" checked="False"
                     label="Exclude hybrid predicted products"
                     help="By default, BGCs with hybrid predicted products from the PKS/NRPS Hybrids and Others classes will be included into each subclass. Since it can happen that the same cluster may appear in different classes you can turn this off here." />
              <param argument="--mode" type="select"
                     label="Alignment Mode"
                     help="Here you can choose between 3 Alignment Mode which are used in comparing each pair of gene cluters. For more information look into the help section!" >
                     <option value="glocal">
                     glocal
                     </option>
                     <option value="global">
                     global
                     </option>
                     <option value="auto">
                     auto
                     </option>
              </param>
              <conditional name="anchor">
                     <param name="is_select" type="select" label="Change Anchorfile?"
                            help="Select yes if you want to use an Anchorfile. BiG-SCAPE has a default file which always be used." >
                            <option value="yes" selected="False"> Yes </option>
                            <option value="no" selected="True"> No </option>
                     </param>
                     <when value="yes">
                            <param argument="--anchorfile" type="data" format=".txt" optional="false"
                                   label="using a different anchorfile instead of default file"
                                   help="Use a custom anchorfile (in .txt format) to give certain domains a special weight in the DSS index." />
                     </when>
                     <when value="no" />
              </conditional>
              <param argument="--force_hmmscan" type="boolean" truevalue="--force_hmmscan" falsevalue="" checked="False"
                     label="Use hmmscan for the domain predicition"
                     help="Even if BiG-SCAPE finds poreccessed domtables files we can force the domain prediciton with hmmscan. Toggle to force hmmscan!" />
              <param argument="--skip_ma" type="boolean" truevalue="--skip_ma" falsevalue="" checked="False"
                     label="Skip multiple alignment of domains sequences"
                     help="Use if alignments have been generated in a previous run. Domain sequence alignment will also be skipped if BiG-SCAPE reutilizes an output directory." />
              <conditional name="mibig">
                     <param name="is_select" type="select" label="Include BGCs from MIBiG database?"
                            help="Select yes and select which version of the database you want to use" >
                            <option value="yes" selected="False"> Yes </option>
                            <option value="no" selected="True"> No </option>
                     </param>
                     <when value="yes">
                            <param name="mibig" type="select" optional="false" label="Version from the MIBiG database"
                                   help="Select which version of the MIBiG databse you want to use." >
                                   <option value="--mibig"> 3.1 </option>
                                   <option value="--mibig21"> 2.1 </option>
                                   <option value="--mibig14"> 1.4 </option>
                                   <option value="--mibig13"> 1.3 </option>
                            </param>
                     </when>
                     <when value="no" />
              </conditional>
              <conditional name="query">
                     <param name="is_select" type="select" label="Compare a diffrent genbank file with all BGCs?"
                            help="Select yes if you want to use a .gbk file to compare with all other BGCs">
                            <option value="yes" selected="False"> Yes </option>
                            <option value="no" selected="True"> No </option>
                     </param>
                     <when value="yes">
                            <param argument="--query_bgc" type="data" format=".gbk" optional="false"
                                   label="using a BGC to compare with all other BGC"
                                   help="Change the mode from all-VS-all to one-VS-all. The BGC which is choose here will be compare to all other BGCs." />
                     </when>
                     <when value="no" />
              </conditional>
              <conditional name="list">
                     <param name="is_select" type="select" label="Use a domain list to include domains?"
                            help="Select yes if you want to use a list to include domains">
                            <option value="yes" selected="False"> Yes </option>
                            <option value="no" selected="True"> No </option>
                     </param>
                     <when value="yes">
                            <param argument="--domain_includelist" type="data" format=".txt" optional="false"
                                   label="Use a .txt file to include domains"
                                   help="Upload a text file where the domains will be added to the run. Looking at the help section to see an example!" />
                     </when>
                     <when value="no" />
              </conditional>
              </inputs>
       <outputs>
              <data name="output" label="graphical_and_network_output : ${tool.name}" from_work_dir="output.zip" format="zip" />
       </outputs>
       <tests>
              <test expect_num_outputs="1">
                     <param name="pfam_dir" value="Pfam-A.hmm" ftype="hmm3"/>
                     <param name="inputdir" value="GCF_000011105.1.gbk,GCF_008000775.1.gbk" ftype="genbank" />
                     <conditional name="include_gbk">
                            <param name="is_select" value="yes"/>
                            <param name="include_gbk_str" value="G"/>
                     </conditional>
              </test>
       </tests>
       <help>
       <![CDATA[
              .. class:: infomark

              **What is BiG-SCAPE**

              BiG-SCAPE (Biosynthetic Gene Similarity Clustering and Prospecting Engine) is a software package, written in Python, that constructs sequence similarity networks of Biosynthetic Gene Clusters (BGCs) and groups them into Gene Cluster Families (GCFs).

              .. class:. infomark

              **What it does**

              BiG-SCAPE does this by rapidly calculating a distance matrix between gene clusters based on a comparison of their protein domain content, order, copy number and sequence identity.

              In principle, BiG-SCAPE can also be used on any other gene clusters, such as pathogenicity islands, secretion system-encoding gene clusters, or even whole viral genomes.

              Here a grapic how BiG-SCAPE works:

              .. image:: bigscape_corason.png
                     :alt: BiG-SCAPE + CORASON workflow

              For more information you can visit `BiG-SCAPE on GitHub <https://github.com/medema-group/BiG-SCAPE>`_ or go on the `combine website <https://bigscape-corason.secondarymetabolites.org/index.html>`_.

              **Input**

              BiG-SCAPE use two kind of inputs:

              - The genbank files from antiSMASH

              .. class:: infomark

              Note: By default BiG-SCAPE include any genbank file where the filename contains either region or cluster. You can use any genbank file with any name but when plese use include option!

              - The Pfamm-A.hmm file

              .. class:: infomark

              Note: You can download this file here: https://www.ebi.ac.uk/interpro/download/pfam/ download here the Pfam-A models or you can use the command: *$ wget https://ftp.ebi.ac.uk/pub/databases/Pfam/current_release/Pfam-A.hmm.gz && gunzip Pfam-A.hmm.gz* in e.g. VSC.

              There are two additionally inputs which can be used:

              - An anchor_domains.txt file

              .. class:: infomark:

              Example (default file which will be used):

              ::
              
               PF00668	Condensation domain [NRPS]
               PF00501	AMP-binding enzyme [NRPS]
               PF00109	Beta-ketoacyl synthase N-terminal [PKS]
               PF02801	Beta-ketoacyl synthase C-terminal [PKS]
               PF01397	Terpene synthase, N-terminal domain (Terpene_synth) [Terpene]
               PF03936	Terpene synthase family, metal binding domain (Terpene_synth_C) [Terpene]
               PF00195	Chalcone and stilbene synthases, N-terminal domain (Cahl_sti_synt_N)
               PF02797	Chalcone and stilbene synthases, C-terminal domain (Chal_sti_synt_C)
               PF05147	Lanthionine synthetase C-like protein (LANC_like) [lantipeptide/RiPP]
               PF00494	Squalene/phytoene synthase (SQS_PSY) [Terpene]
               PF00432	Prenyltransferase and squalene oxidase repeat (Prenyltrans)
               PF02624	YcaO cyclodehydratase, ATP-ad MG2+-binding (YcaO) [RiPP]
              
              The first column contain the hmm model id while the second column is opionally for write a comment. The columns are tab seperated!

              - A domain_includelist.txt

              .. class:: infomark

              Example:

              ::

               PF00067       Cytochrome P450
               PF01451       Any Comment

              The first column contain the hmm model id while the second column is opionally for write a comment. The columns are tab seperated and any line which start with a # will be ignored!


              **Output**

              BiG-SCAPE create a .hmt file where you can see all the result in certain graphics. It also produce for each BiG-SCAPE class there own .tsv file. It will also outout a .tsv file where evreything will be written in. The last output will be a dirrectoy whrer the whole content for the .hmtl file will be stored. This tool will provide this output as a .zip file since the order of each file/directory is important sicne the .html file doesn't work without it!

              **Additionally information for the alignment Mode**

              - glocal: Is the default mode. Here the subset of the domains used to calculate distance is redefined by finding the longest slice of common domain content per gene in both BGCs, then expands each slice.

              - global: The whole list if domains of each BGC are compared.

              - auto: Use glocal mode when at least one of the BGCs in each pair has the contig_edge annotation from antiSMASH. Otherwise global will be used.
       ]]>
       </help>
       <citations>
              <citation type="doi">10.1038/s41589-019-0400-9</citation>
       </citations>
</tool>